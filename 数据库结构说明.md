# 数据库结构说明

## 数据库概述

本系统使用SQLite数据库存储六合彩相关数据，包括开奖结果、号码频率统计和预测记录。

## 数据表结构

### 1. lottery_results (开奖结果表)

存储六合彩历史开奖数据。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| original_id | INTEGER | UNIQUE, NOT NULL | API返回的原始ID |
| type | INTEGER | NOT NULL | 彩票类型 (1=双色球) |
| type_name | VARCHAR(50) | NOT NULL | 彩票类型名称 |
| issue_number | VARCHAR(20) | UNIQUE, NOT NULL | 期号 |
| lottery_date | DATE | NOT NULL | 开奖日期 |
| week | VARCHAR(10) | NOT NULL | 星期 |
| win_code | VARCHAR(100) | NOT NULL | 完整中奖号码字符串 |
| red_balls | VARCHAR(50) | NOT NULL | 红球号码 (逗号分隔) |
| blue_ball | INTEGER | NOT NULL | 蓝球号码 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**示例数据:**
```sql
INSERT INTO lottery_results VALUES (
    1, 35740, 1, '双色球', '2025088', '2025-08-03', '日',
    '01,03,13,18,21,25,06', '01,03,13,18,21,25', 6,
    '2025-08-05 09:12:09', '2025-08-05 09:12:09'
);
```

### 2. number_frequency (号码频率统计表)

存储红球和蓝球的出现频率统计。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| number | INTEGER | NOT NULL | 号码 (红球1-33, 蓝球1-16) |
| ball_type | VARCHAR(10) | NOT NULL | 球类型 ('red'/'blue') |
| frequency | INTEGER | DEFAULT 0 | 总出现次数 |
| last_appeared | DATE | | 最后出现日期 |
| days_since_last | INTEGER | DEFAULT 0 | 距离上次出现天数 |
| frequency_1year | INTEGER | DEFAULT 0 | 近1年出现次数 |
| frequency_2year | INTEGER | DEFAULT 0 | 近2年出现次数 |
| frequency_3year | INTEGER | DEFAULT 0 | 近3年出现次数 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**示例数据:**
```sql
INSERT INTO number_frequency VALUES (
    1, 1, 'red', 25, '2025-08-03', 2, 12, 20, 25,
    '2025-08-05 09:12:09'
);
```

### 3. prediction_results (预测结果表)

存储系统生成的预测结果和准确性评估。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| prediction_date | DATE | NOT NULL | 预测日期 |
| predicted_issue | VARCHAR(20) | NOT NULL | 预测期号 |
| predicted_red_balls | VARCHAR(50) | NOT NULL | 预测红球号码 |
| predicted_blue_ball | INTEGER | NOT NULL | 预测蓝球号码 |
| predicted_win_code | VARCHAR(100) | NOT NULL | 预测完整号码 |
| algorithm_used | VARCHAR(50) | NOT NULL | 使用的算法 |
| confidence_score | FLOAT | DEFAULT 0.0 | 置信度分数 |
| actual_win_code | VARCHAR(100) | | 实际开奖号码 |
| matches_count | INTEGER | DEFAULT 0 | 匹配号码数量 |
| is_accurate | BOOLEAN | DEFAULT FALSE | 是否预测准确 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**示例数据:**
```sql
INSERT INTO prediction_results VALUES (
    1, '2025-08-05', '2025089', '02,17,18,20,22,33', 16,
    '02,17,18,20,22,33,16', 'frequency', 0.6, NULL, 0, 0,
    '2025-08-05 09:15:30', '2025-08-05 09:15:30'
);
```

### 4. users (用户表)

系统用户信息表（模板自带）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| username | VARCHAR(80) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(120) | UNIQUE, NOT NULL | 邮箱 |

## 数据关系

### 主要关系
- `lottery_results` 表是核心数据表，存储所有历史开奖信息
- `number_frequency` 表通过统计 `lottery_results` 中的号码生成
- `prediction_results` 表基于历史数据生成预测，可与后续的 `lottery_results` 对比验证

### 数据流向
```
API数据 → lottery_results → number_frequency → prediction_results
                ↓
            趋势分析 → 预测算法 → 预测结果
```

## 索引优化

### 建议索引
```sql
-- 开奖结果表索引
CREATE INDEX idx_lottery_date ON lottery_results(lottery_date);
CREATE INDEX idx_issue_number ON lottery_results(issue_number);

-- 频率统计表索引
CREATE INDEX idx_number_type ON number_frequency(number, ball_type);
CREATE INDEX idx_frequency ON number_frequency(frequency DESC);

-- 预测结果表索引
CREATE INDEX idx_prediction_date ON prediction_results(prediction_date);
CREATE INDEX idx_predicted_issue ON prediction_results(predicted_issue);
```

## 数据维护

### 定期维护任务
1. **数据更新**: 定期调用API获取最新开奖数据
2. **频率统计更新**: 每次新增开奖数据后更新频率统计
3. **预测验证**: 开奖后验证预测结果准确性
4. **数据清理**: 清理过期的临时数据

### 数据备份
```bash
# 备份数据库
cp src/database/app.db backup/app_$(date +%Y%m%d).db

# 恢复数据库
cp backup/app_20250805.db src/database/app.db
```

## 查询示例

### 常用查询语句

1. **获取最新10期开奖结果**
```sql
SELECT * FROM lottery_results 
ORDER BY lottery_date DESC 
LIMIT 10;
```

2. **查询红球号码频率排行**
```sql
SELECT number, frequency, days_since_last 
FROM number_frequency 
WHERE ball_type = 'red' 
ORDER BY frequency DESC;
```

3. **获取近期预测记录**
```sql
SELECT predicted_issue, predicted_win_code, algorithm_used, confidence_score
FROM prediction_results 
ORDER BY prediction_date DESC 
LIMIT 5;
```

4. **统计各算法预测准确率**
```sql
SELECT algorithm_used, 
       COUNT(*) as total_predictions,
       SUM(CASE WHEN is_accurate THEN 1 ELSE 0 END) as accurate_predictions,
       ROUND(100.0 * SUM(CASE WHEN is_accurate THEN 1 ELSE 0 END) / COUNT(*), 2) as accuracy_rate
FROM prediction_results 
WHERE actual_win_code IS NOT NULL
GROUP BY algorithm_used;
```

## 性能考虑

### 查询优化
- 使用适当的索引加速查询
- 避免全表扫描
- 合理使用分页查询

### 存储优化
- 定期清理无用数据
- 压缩历史数据
- 监控数据库大小

### 并发控制
- SQLite支持读并发，写操作需要排队
- 对于高并发场景，考虑升级到PostgreSQL或MySQL

